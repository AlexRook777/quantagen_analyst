# QuantaGen Analyst: A Hybrid AI Financial Analyst

![alt text](image.png)

QuantaGen Analyst is a production-ready, high-performance API that serves as a hybrid AI financial analyst. It integrates two distinct AI-driven agents to provide a comprehensive analysis of public companies:

- **The "Quant-Agent" (Quantitative)**: An advanced Deep Learning model (PyTorch) that forecasts future stock prices based on numerical time-series data.
- **The "Archive-Agent" (Qualitative)**: An advanced RAG agent (LangChain + Gemini) that "reads" official 10-K filings to answer complex questions about business risks, strategy, and performance.

This repository is a portfolio project designed to demonstrate a full-stack MLOps architecture: from raw data ingestion and model training (offline) to a high-performance, asynchronous, and cached API (online).

## ðŸš€ Key Features (API Endpoints)

### POST /forecast
Accepts a stock ticker and returns a 7-day price forecast generated by the "Quant-Agent" (PyTorch LSTM/Attention).

### POST /ask_filing
Accepts a ticker and a question. The "Archive-Agent" (RAG) finds relevant sections in the company's 10-K filings and generates a fact-based answer with source citations.

### POST /comprehensive_analysis
A single endpoint that asynchronously and concurrently (asyncio.gather) runs both agents, combining the numerical forecast and the textual RAG analysis into one JSON response.

### GET /health
A standard monitoring endpoint that confirms the API is live and its services (singletons) are initialized.

## ðŸ’¡ Architecture & Engineering Highlights

This project was engineered with a focus on performance, reliability, and scalability. It demonstrates the following in-demand engineering patterns:

### 1. Hybrid AI System
The architecture merges two pillars of modern AI:
- **Classical Deep Learning (PyTorch)**: Used for structured time-series forecasting, demonstrating an understanding of recurrent models.
- **Generative AI (LangChain + Google Gemini)**: Used for unstructured text analysis and generative question-answering.

### 2. Performance: Async, Caching & Singletons
The API is built on FastAPI using async/await for non-blocking I/O.

- **Asynchronous Execution**: Heavy, blocking ML/AI operations (get_forecast_async, get_rag_response_async) are run in separate threads (asyncio.to_thread) to prevent blocking the main server loop.
- **Concurrency**: The /comprehensive_analysis endpoint uses asyncio.gather to execute the network/LLM-bound RAG query and the network/CPU-bound forecast in parallel, dramatically reducing total response time.
- **Singleton Pattern**: Both heavy services (ForecastService and RAGService) are implemented as singletons. This is critical for performance, ensuring that heavy artifacts (PyTorch model, scaler, embedding model) are loaded into memory only once at API startup (lifespan), not on every request.
- **Caching (cachetools)**: To minimize LLM costs and API latency:
  - RAG Service uses TTLCache to cache LLM responses for 1 hour, saving API costs on repeated questions.
  - Forecast Service uses @cachetools.func.ttl_cache to cache price forecasts for 15 minutes, reducing yfinance API calls and CPU load.

### 3. Advanced RAG Pipeline
The "Archive-Agent" is not a simple "similarity search."

- **Local Embeddings**: Uses HuggingFaceEmbeddings (all-MiniLM-L6-v2) to generate vectors locally. This ensures privacy (no sensitive financial data is sent to a third party) and zero cost.
- **Metadata Filtering**: The RAG query analyzes the user's question (enhanced_retrieval in rag_service.py). If a user asks about "risks," the search is filtered to only query chunks in ChromaDB with the metadata `{"section": "risk_factors"}`. This provides vastly superior relevance.
- **Source Citation**: The LLM prompt is engineered to require citations ([Source N]), and the final API response includes the source documents, making the answer verifiable.

### 4. Advanced Deep Learning Model (PyTorch)
The forecasting model (forecaster.py) is not a basic LSTM.

- **LSTM with Attention**: Instead of relying only on the final hidden state of the LSTM (lstm_out[:, -1, :]), the model uses a custom Attention mechanism. This allows the model to "look back" at all 60 days in the window and dynamically weigh which days were most important for the prediction, which is critical for noisy financial data.
- **Regularization**: The model head uses Dropout and LayerNorm for stability and to combat overfitting.

### 5. MLOps Lifecycle (Offline vs. Online)
The project strictly separates offline training from online inference.

**Offline (in /scripts):**
- `train.py`: A script for feature engineering, training the PyTorch model, and saving the artifacts (.pth, .joblib).
- `ingest.py`: A script to download 10-K reports (via sec_api), chunk them, tag them with metadata, and populate the ChromaDB.

**Online (in /api):**
- The FastAPI application only loads the pre-trained artifacts for high-speed, read-only inference.

## ðŸ›  Tech Stack

- **Backend**: FastAPI, Uvicorn
- **AI (Deep Learning)**: PyTorch (LSTM, Attention)
- **AI (Generative)**: LangChain, Google Gemini (gemini-2.5-flash)
- **Vector Database**: ChromaDB
- **Embeddings**: HuggingFace Sentence Transformers (Local)
- **Data Processing**: Pandas, Pandas-ta (Feature Engineering), Scikit-learn (MinMaxScaler)
- **Async & Caching**: asyncio, cachetools
- **Data Ingestion**: yfinance, sec-api

## ðŸ“‚ Project Structure

```
/quantagen_analyst/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â””â”€â”€ forecaster.py   # (PyTorch Model Architecture)
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ forecast_service.py # (Logic for "Quant-Agent")
â”‚   â”‚   â”‚   â””â”€â”€ rag_service.py      # (Logic for "Archive-Agent")
â”‚   â”‚   â””â”€â”€ main.py           # (FastAPI: Endpoints, Lifespan, Middleware)
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ ingest.py         # (Offline script to populate ChromaDB)
â”‚   â”‚   â””â”€â”€ train.py          # (Offline script to train PyTorch model)
â”‚   â”‚
â”‚   â””â”€â”€ saved_models/
â”‚       â”œâ”€â”€ quant_model.pth   # (Trained PyTorch weights)
â”‚       â””â”€â”€ scaler.joblib     # (Trained Scikit-learn scaler)
â”‚
â”œâ”€â”€ data/
â”‚   â””â”€â”€ chroma_data/          # (Persistent ChromaDB vector store)
â”‚
â”œâ”€â”€ .env                      # (Your API Keys)
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

## ðŸš€ How to Run (Local Setup)

### Pre-requisites:
- Python 3.10+
- GOOGLE_API_KEY (for Google Gemini)
- SEC_API_KEY (for downloading 10-K reports)

### 1. Clone the Repository:
```bash
git clone https://github.com/AlexRook777/quantagen_analyst.git
cd quantagen_analyst
```

### 2. Set up Virtual Environment and Install Dependencies:
```bash
python -m venv venv
source venv/bin/activate  # (or venv\Scripts\activate on Windows)
pip install -r api/requirements.txt
```

### 3. Configure Environment Variables:
Create a file named `.env` in the project root (/quantagen_analyst/) and add your API keys:
```env
GOOGLE_API_KEY="your_gemini_api_key_here"
SEC_API_KEY="your_sec_api_key_here"
```

### 4. Run Offline Processes (One-Time Setup):

**A) Train the "Quant-Agent":**
This script runs once. It will train the PyTorch model and create the quant_model.pth and scaler.joblib files.
```bash
python api/scripts/train.py
```

**B) Ingest Data for the "Archive-Agent":**
This script runs once per ticker (e.g., 'AAPL'). It downloads 10-K reports, processes them, and populates the ChromaDB in /data/.
```bash
python api/scripts/ingest.py
```

### 5. Run the API Server:
```bash
uvicorn api.app.main:app --reload
```

The server will be live at http://127.0.0.1:8000

## ðŸ•¹ API Usage Examples

### 1. Get Forecast (Quant-Agent)
```bash
curl -X 'POST' \
  'http://127.0.0.1:8000/forecast' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "ticker": "AAPL"
}'
```

### 2. Ask RAG Agent (Archive-Agent)
```bash
curl -X 'POST' \
  'http://127.0.0.1:8000/ask_filing' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "ticker": "AAPL",
  "question": "What are the main risks related to competition?"
}'
```

### 3. Comprehensive Analysis (Concurrent)
```bash
curl -X 'POST' \
  'http://127.0.0.1:8000/comprehensive_analysis' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "ticker": "AAPL",
  "question": "What are the main risks related to competition?"
}'

Sample of response (JSON):
{
    "ticker": "AAPL",
    "question": "What are the main risks related to competition?",
    "forecast": {
        "ticker": "AAPL",
        "forecast_days": 7,
        "forecast": [
            259.2048594115613,
            264.3687193658502,
            254.3789005319809,
            255.95852485093474,
            259.49839310784455,
            259.9076887004526,
            255.35245464500122
        ],
        "generated_at": "2025-11-09T05:14:38.035490+00:00",
        "model_version": "1.0.0"
    },
    "rag_analysis": {
        "ticker": "AAPL",
        "question": "What are the main risks related to competition?",
        "answer": "The main risks related to competition include:\n\n*   **Imitation and Innovation Challenges**\n    *   Competitors imitate the Companyâ€™s product features and applications within their own products to offer more competitive solutions [Source 1, Source 5, Source 6].\n    *   Competition is expected to intensify as competitors imitate the Companyâ€™s approach to providing components seamlessly within their offerings or work collaboratively to offer integrated solutions [Source 1, Source 5].\n    *   The Company must successfully manage frequent introductions and transitions of products and services to remain competitive and stimulate customer demand [Source 1].\n    *   There is a risk that the Company may be unable to continue to develop and sell innovative new products with attractive margins [Source 2, Source 3, Source 4, Source 6]. Significant investments in R&D are required, with no assurance of expected returns or successful development and marketing of new products and services [Source 3].\n\n*   **Aggressive Pricing and Cost Structures**\n    *   Many competitors seek to compete primarily through aggressive pricing and very low cost structures [Source 2, Source 3, Source 4, Source 6].\n    *   Competition has been particularly intense as competitors have aggressively cut prices and lowered product margins [Source 1, Source 2, Source 4, Source 5].\n    *   Certain competitors have the resources, experience, or cost structures to provide products and services at little or no profit or even at a loss [Source 1, Source 5].\n\n*   **Competitor Strengths and Resources**\n    *   The Company faces substantial competition from companies that have significant technical, marketing, distribution, and other resources [Source 2, Source 4, Source 5, Source 6].\n    *   Competitors have established hardware, software, and digital content supplier relationships [Source 2, Source 4, Source 5, Source 6].\n    *   Some competitors have broader product lines, lower-priced products, and a larger installed base of active devices and customer bases [Source 1, Source 2, Source 4, Source 5].\n\n*   **Intellectual Property Infringement**\n    *   Competitors often infringe on the Companyâ€™s intellectual property [Source 2, Source 3, Source 4, Source 6].\n    *   Effective intellectual property protection is not consistently available in every country where the Company operates [Source 2, Source 3, Source 4, Source 6].\n    *   If competitors infringe on the Companyâ€™s intellectual property, its ability to maintain a competitive advantage could be materially adversely affected [Source 2, Source 3, Source 4, Source 6].\n\n*   **Market Position and Growth**\n    *   The Company has a minority market share in the global smartphone, personal computer, tablet, and wearables markets [Source 1, Source 2, Source 3, Source 4, Source 5].\n    *   Some markets in which the Company competes have from time to time experienced little to no growth or have contracted overall [Source 1, Source 5].\n\n*   **Antitrust Investigations and Litigation**\n    *   The Company is subject to antitrust investigations and litigation globally, including civil antitrust lawsuits in the U.S. alleging monopolization in smartphone markets and investigations in Europe related to App Store terms and conditions [Source 7].\n    *   If these investigations or litigation are resolved against the Company, it could be exposed to significant fines, required to make changes to its business practices, or even required to share its innovations with competitors, which would negatively impact its competitive advantage [Source 6, Source 7].\n\nFailure to compete successfully in the face of these risks can materially adversely affect the Companyâ€™s business, reputation, results of operations, financial condition, and stock price [Source 1, Source 7].",
        "retrieval_count": 10,
        "sources": [
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_1.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_5.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_2.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_4.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_3.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_1.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_1.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_5.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_4.pdf",
                "page": "N/A"
            },
            {
                "source": "C:\\Repos\\_my\\quantagen_analyst\\data\\pdfs\\AAPL\\AAPL_10K_2.pdf",
                "page": "N/A"
            }
        ]
    }
}